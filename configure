#!/bin/bash
# Configure script for accis.

# Compiler choice.
if [ "$COMPILER" == "" ] ; then
if [ -x "`which mpif77`" ] ; then
# By default use mpif77
   COMPILER="mpif77"
#   if [ -x "`which g77`" ] ; then
#       COMPILER="$COMPILER -f77=g77"
#   fi
   echo Choosing compiler $COMPILER.  Overrule by COMPILER="your compiler"
else
# Else use gfortran or g77.
   if [ -x "`which gfortran`" ] ; then
      echo Choosing compiler gfortran.  Overrule by COMPILER="your compiler"
      COMPILER=gfortran
   else
	if [ -x "`which g77`" ] ; then
     	   echo Choosing compiler g77.  Overrule by COMPILER="your compiler"
     	   COMPILER=g77
	else
	   echo Did not find mpif77 g77 or gfortran.
	   if [ -x "`which $F77`" ] ; then
	       echo Using ${F77}
	       COMPILER=$F77
	   else
	       echo Could not find a fortran compiler. Use COMPILER=...
	       exit
	   fi
     	fi
   fi   
fi
fi

if [ "$NOBACKSLASH" == "" ] ; then
    if [ -n "`$COMPILER --version | grep GNU`" ] ; then
	NOBACKSLASH="-w -fno-backslash"
    else 
	if [ -n "`$COMPILER --version | grep PathScale`" ] ; then
	    NOBACKSLASH=-backslash
	else 
	    if [ -n "`$COMPILER --version | grep Portland`" ] ; then
		NOBACKSLASH=-Mbackslash
	    fi
	fi
    fi
    echo Set NOBACKSLASH=$NOBACKSLASH . Overrule by NOBACKSLASH= ...
fi


# Xlib choice.
if [ "`uname -m`" == "x86_64" ] ; then 
   Xlib=/usr/lib/
fi

# VECX choice
if [ "$VECX" == "" ] ; then
  if [ -z "`ld -lGLU -lGL -o /dev/null 2>&1 | grep GL`" ] ; then
    echo Choosing to use GLX driver
    VECX=vecglx
  else 
    echo Can\'t find -lGL -lGLU. Trying X11 driver
    if [ -z "`ld -lX11 -o /dev/null 2>&1 | grep X`" ] ; then
        VECX=vecx
    else
	echo Can\'t find -lX11. Using 4014 driver
        VECX=vec4014
    fi
  fi
fi

# Threaded version?
#if [ -f /usr/include/pthread.h ] ; then
#    echo Pthreads available, but not used.
# Currently this works on thinkpad but not on (e.g.) horace.
#    echo Using pthreads.
#    Threading="-DPTHREADS"
#fi

cat > makefile <<EOF
# This is the configured makefile, which is used for the full make.
################ DO NOT EDIT THIS FILE. EDIT Makefile #############
# Here we have stuff that we determine by configuration.
G77=$COMPILER
NOBACKSLASH=$NOBACKSLASH
THREADING=$Threading
XLIB=$Xlib
ifeq ("\$(VECX)","")
  VECX=$VECX
endif
# That ends by having the original Makefile tacked on the end.
###################################################################
EOF
cat Makefile >>makefile
